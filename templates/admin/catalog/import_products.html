{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}{{ block.super }}
<style>
.import-container {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #333;
}

input.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
}

input.form-control:focus {
    outline: none;
    border-color: #79aec8;
    box-shadow: 0 0 0 3px rgba(121, 174, 200, 0.1);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è Select2 */
.select2-container {
    width: 100% !important;
}

.select2-container--default .select2-selection--single {
    height: 42px !important;
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
    padding: 0 !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 40px !important;
    padding-left: 12px !important;
    padding-right: 30px !important;
    color: #333 !important;
    font-size: 14px !important;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 40px !important;
    top: 1px !important;
    right: 1px !important;
}

.form-help {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
    font-style: italic;
}

.checkbox-group {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 4px;
}

.checkbox-group input {
    margin-right: 10px;
    width: 18px;
    height: 18px;
}

.checkbox-group label {
    margin: 0;
    font-weight: normal;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    display: inline-block;
    margin-right: 10px;
    transition: background 0.2s;
}

.btn-primary {
    background: #79aec8;
    color: white;
}

.btn-primary:hover {
    background: #68a3be;
}

.btn-secondary {
    background: #ddd;
    color: #333;
}

.btn-secondary:hover {
    background: #ccc;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.file-drop-area {
    border: 2px dashed #ddd;
    border-radius: 4px;
    padding: 40px;
    text-align: center;
    margin-bottom: 20px;
    transition: all 0.3s;
    cursor: pointer;
    background: #fafafa;
}

.file-drop-area.dragover {
    border-color: #79aec8;
    background: #f0f8ff;
}

.file-drop-area.file-selected {
    border-color: #28a745;
    background: #f0fff4;
}

.file-drop-area p {
    margin: 0;
    color: #666;
    font-size: 14px;
}

.template-info {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.template-info h3 {
    margin-top: 0;
    color: #0066cc;
    font-size: 16px;
}

.template-info ul {
    margin-bottom: 0;
    padding-left: 20px;
}

.template-info li {
    margin-bottom: 8px;
    line-height: 1.5;
}

.category-select-info {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 12px;
    border-radius: 4px;
    margin-top: 8px;
    font-size: 13px;
    color: #856404;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
    display: none;
}

.progress-fill {
    height: 100%;
    background: #79aec8;
    width: 0%;
    transition: width 0.3s;
}

.cancel-btn {
    display: none;
    margin-left: 10px;
}
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="import-container">
        <h1>{{ title }}</h1>
        
        <div class="template-info">
            <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∏–º–ø–æ—Ä—Ç—É</h3>
            <ul>
                <li><strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</strong> CSV, XLSX, JSON</li>
                <li><strong>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:</strong> title (–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞)</li>
                <li><strong>–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:</strong> article, description, category, availability, details, images, url</li>
                <li><strong>–í–∞–∂–Ω–æ:</strong> –¢–æ–≤–∞—Ä—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –ø–æ <u>–Ω–∞–∑–≤–∞–Ω–∏—é (title)</u></li>
                <li><a href="{% url 'catalog:download_import_template' %}" class="btn btn-secondary" style="margin-top: 10px;">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω CSV</a></li>
            </ul>
        </div>
        
        <form method="post" enctype="multipart/form-data" id="import-form" action="{% url 'catalog:import_products' %}">
            {% csrf_token %}
            
            <!-- –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div class="form-group">
                <label for="{{ form.category.id_for_label }}">
                    üìÅ {{ form.category.label }}
                </label>
                {{ form.category }}
                <div class="category-select-info">
                    üí° <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —á—Ç–æ–±—ã –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ —Ñ–∞–π–ª–∞ –¥–æ–±–∞–≤–∏–ª–∏—Å—å –≤ –Ω–µ—ë. 
                    –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–∑ —Å—Ç–æ–ª–±—Ü–∞ "category" –≤ —Ñ–∞–π–ª–µ.
                </div>
                {% if form.category.help_text %}
                    <div class="form-help">{{ form.category.help_text }}</div>
                {% endif %}
            </div>
            
            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
            <div class="form-group">
                <label for="id_file">{{ form.file.label }}</label>
                {{ form.file }}
                {% if form.file.help_text %}
                    <div class="form-help">{{ form.file.help_text }}</div>
                {% endif %}
            </div>
            
            <!-- –û–ø—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∞ -->
            <div class="checkbox-group">
                {{ form.update_existing }}
                <label for="{{ form.update_existing.id_for_label }}">
                    {{ form.update_existing.label }}
                    {% if form.update_existing.help_text %}
                        <span class="form-help" style="display: block; margin-top: 5px;">{{ form.update_existing.help_text }}</span>
                    {% endif %}
                </label>
            </div>
            
            <div class="checkbox-group">
                {{ form.delete_missing }}
                <label for="{{ form.delete_missing.id_for_label }}">
                    {{ form.delete_missing.label }}
                    {% if form.delete_missing.help_text %}
                        <span class="form-help" style="display: block; margin-top: 5px;">{{ form.delete_missing.help_text }}</span>
                    {% endif %}
                </label>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary" id="import-btn">
                    üöÄ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
                </button>
                <button type="button" class="btn btn-danger cancel-btn" id="cancel-btn" style="display: none;">
                    ‚õî –û—Ç–º–µ–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç
                </button>
                <a href="{% url 'admin:catalog_product_changelist' %}" class="btn btn-secondary">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </a>
            </div>
            
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
            <div class="progress-bar" id="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            
            <!-- –õ–æ–≥ –∏–º–ø–æ—Ä—Ç–∞ -->
            <div id="import-log" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; max-height: 400px; overflow-y: auto;">
                <h4 style="margin-top: 0; color: #495057;">üìã –õ–æ–≥ –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤</h4>
                <div id="log-content" style="font-family: monospace; font-size: 12px; line-height: 1.4;">
                    <div style="color: #6c757d;">–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–º–ø–æ—Ä—Ç–∞...</div>
                </div>
            </div>
            
            <div id="result-message"></div>
        </form>
    </div>
</div>

<script>
// AJAX —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
document.addEventListener('DOMContentLoaded', function() {
    const importForm = document.getElementById('import-form');
    const importBtn = document.getElementById('import-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const importLog = document.getElementById('import-log');
    const logContent = document.getElementById('log-content');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let currentRequest = null;
    let progressInterval = null;
    
    if (importForm && importBtn && cancelBtn) {
        importForm.addEventListener('submit', function(e) {
            e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ñ–∞–π–ª
            const fileInput = document.querySelector('input[name="file"]');
            const categorySelect = document.querySelector('select[name="category"]');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
                return false;
            }
            
            if (!categorySelect.value) {
                const confirmed = window.confirm(
                    '‚ö†Ô∏è –í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!\n\n' +
                    '–°–∏—Å—Ç–µ–º–∞ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–∑ —Ñ–∞–π–ª–∞.\n' +
                    '–≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º, –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.\n\n' +
                    '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏?'
                );
                
                if (!confirmed) {
                    return false;
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –ª–æ–≥ —Å—Ä–∞–∑—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∏–º–ø–æ—Ä—Ç–∞
            progressBar.style.display = 'block';
            importLog.style.display = 'block';
            
            // –û—á–∏—â–∞–µ–º –ª–æ–≥
            logContent.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const progressEntry = document.createElement('div');
            progressEntry.id = 'progress-entry';
            progressEntry.style.color = '#6c757d';
            progressEntry.innerHTML = '‚è≥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∏–º–ø–æ—Ä—Ç—É...';
            logContent.appendChild(progressEntry);
            logContent.scrollTop = logContent.scrollHeight;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏–º–ø–æ—Ä—Ç–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
            importBtn.disabled = true;
            importBtn.textContent = '‚è≥ –ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
            cancelBtn.style.display = 'inline-block';
            
            // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            const formData = new FormData(importForm);
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è AJAX –∑–∞–ø—Ä–æ—Å–∞
            formData.append('ajax', 'true');
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π XMLHttpRequest
            currentRequest = new XMLHttpRequest();
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            currentRequest.onreadystatechange = function() {
                if (currentRequest.readyState === XMLHttpRequest.DONE) {
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
                    cancelBtn.style.display = 'none';
                    
                    // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    progressFill.style.width = '100%';
                    
                    if (currentRequest.status === 200) {
                        try {
                            const response = JSON.parse(currentRequest.responseText);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥
                            const finalEntry = document.createElement('div');
                            finalEntry.style.color = '#007bff';
                            finalEntry.innerHTML = '‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!';
                            logContent.appendChild(finalEntry);
                            logContent.scrollTop = logContent.scrollHeight;
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                            if (response.success) {
                                const successEntry = document.createElement('div');
                                successEntry.style.color = '#28a745';
                                successEntry.style.fontWeight = 'bold';
                                successEntry.innerHTML = 'üéâ ' + response.message;
                                logContent.appendChild(successEntry);
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏
                                if (response.imported !== undefined) {
                                    const importedEntry = document.createElement('div');
                                    importedEntry.style.color = '#28a745';
                                    importedEntry.innerHTML = `‚úÖ –°–æ–∑–¥–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${response.imported}`;
                                    logContent.appendChild(importedEntry);
                                }
                                
                                if (response.updated !== undefined) {
                                    const updatedEntry = document.createElement('div');
                                    updatedEntry.style.color = '#17a2b8';
                                    updatedEntry.innerHTML = `üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${response.updated}`;
                                    logContent.appendChild(updatedEntry);
                                }
                                
                                if (response.skipped !== undefined) {
                                    const skippedEntry = document.createElement('div');
                                    skippedEntry.style.color = '#ffc107';
                                    skippedEntry.innerHTML = `‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${response.skipped}`;
                                    logContent.appendChild(skippedEntry);
                                }
                                
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                                if (response.errors && response.errors.length > 0) {
                                    const errorsHeader = document.createElement('div');
                                    errorsHeader.style.color = '#dc3545';
                                    errorsHeader.style.fontWeight = 'bold';
                                    errorsHeader.innerHTML = '‚ùå –û—à–∏–±–∫–∏:';
                                    logContent.appendChild(errorsHeader);
                                    
                                    response.errors.forEach(error => {
                                        const errorEntry = document.createElement('div');
                                        errorEntry.style.color = '#dc3545';
                                        errorEntry.innerHTML = `‚ùå ${error}`;
                                        logContent.appendChild(errorEntry);
                                    });
                                }
                                
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
                                if (response.warnings && response.warnings.length > 0) {
                                    const warningsHeader = document.createElement('div');
                                    warningsHeader.style.color = '#ffc107';
                                    warningsHeader.style.fontWeight = 'bold';
                                    warningsHeader.innerHTML = '‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:';
                                    logContent.appendChild(warningsHeader);
                                    
                                    response.warnings.forEach(warning => {
                                        const warningEntry = document.createElement('div');
                                        warningEntry.style.color = '#ffc107';
                                        warningEntry.innerHTML = `‚ö†Ô∏è ${warning}`;
                                        logContent.appendChild(warningEntry);
                                    });
                                }
                            } else {
                                const errorEntry = document.createElement('div');
                                errorEntry.style.color = '#dc3545';
                                errorEntry.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + (response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                                logContent.appendChild(errorEntry);
                            }
                        } catch (e) {
                            const errorEntry = document.createElement('div');
                            errorEntry.style.color = '#dc3545';
                            errorEntry.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞: ' + e.message;
                            logContent.appendChild(errorEntry);
                        }
                    } else if (currentRequest.status === 0) {
                        // –ó–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω
                        const cancelEntry = document.createElement('div');
                        cancelEntry.style.color = '#ffc107';
                        cancelEntry.innerHTML = '‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
                        logContent.appendChild(cancelEntry);
                        logContent.scrollTop = logContent.scrollHeight;
                    } else {
                        const errorEntry = document.createElement('div');
                        errorEntry.style.color = '#dc3545';
                        errorEntry.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + currentRequest.status;
                        logContent.appendChild(errorEntry);
                    }
                    
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                    importBtn.disabled = false;
                    importBtn.textContent = 'üöÄ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã';
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –ª–æ–≥ –≤–Ω–∏–∑
                    logContent.scrollTop = logContent.scrollHeight;
                }
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            currentRequest.open('POST', importForm.action);
            currentRequest.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            currentRequest.send(formData);
            
            // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å –ø–æ–º–æ—â—å—é –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            
            // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            progressInterval = setInterval(function() {
                // –ó–¥–µ—Å—å –º—ã –º–æ–≥–ª–∏ –±—ã –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                // –ù–æ —Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å –Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ endpoint –¥–ª—è —ç—Ç–æ–≥–æ,
                // –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é —ç–º—É–ª—è—Ü–∏—é
                
                // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
                // –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                
                // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                fetch('{% url "catalog:import_progress" %}', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    const percentage = data.percentage || 0;
                    const processed = data.processed || 0;
                    const total = data.total || 0;
                    
                    progressFill.style.width = percentage + '%';
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
                    let progressElement = document.getElementById('progress-entry');
                    if (!progressElement) {
                        progressElement = document.createElement('div');
                        progressElement.id = 'progress-entry';
                        progressElement.style.color = '#6c757d';
                        logContent.appendChild(progressElement);
                    }
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞–¥–∏–∏ –∏–º–ø–æ—Ä—Ç–∞
                    if (percentage >= 100) {
                        progressElement.innerHTML = '‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!';
                    } else if (total > 0) {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
                        progressElement.innerHTML = `‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤: ${processed} –∏–∑ ${total} (${percentage}%)`;
                    } else {
                        // –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è
                        progressElement.innerHTML = `‚è≥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∏–º–ø–æ—Ä—Ç—É...`;
                    }
                    
                    logContent.scrollTop = logContent.scrollHeight;
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                });
            }, 500);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
        cancelBtn.addEventListener('click', function() {
            if (currentRequest) {
                // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ—Ç–º–µ–Ω—ã –∏–º–ø–æ—Ä—Ç–∞
                fetch('{% url "catalog:cancel_import" %}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ—Ç–º–µ–Ω—É:', data);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∏–º–ø–æ—Ä—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', error);
                })
                .finally(() => {
                    // –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º —ç—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–º–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                    
                    // –û—Ç–º–µ–Ω—è–µ–º XMLHttpRequest –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                    currentRequest.abort();
                    currentRequest = null;
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
                    cancelBtn.style.display = 'none';
                    
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏–º–ø–æ—Ä—Ç–∞
                    importBtn.disabled = false;
                    importBtn.textContent = 'üöÄ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ –≤ –ª–æ–≥
                    const cancelEntry = document.createElement('div');
                    cancelEntry.style.color = '#ffc107';
                    cancelEntry.innerHTML = '‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
                    logContent.appendChild(cancelEntry);
                    logContent.scrollTop = logContent.scrollHeight;
                });
            }
        });
    }
});
</script>
{% endblock %}